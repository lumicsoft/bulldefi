<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiexDefai | Real-Time Live Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root { --p: #00ffa3; --bg: #0b0e11; --card: #161a1e; --text: #eaecef; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #2b2f36; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #474d57; background: #1e2329; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--p); color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-2px); }
        .console { background: #000; color: #00ff00; padding: 15px; height: 180px; overflow-y: auto; border-radius: 8px; font-family: monospace; font-size: 13px; border: 1px solid #333; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .stat-item { background: #1e2329; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #2b2f36; }
        .stat-val { display: block; color: var(--p); font-size: 18px; font-weight: bold; }
        .live-tag { font-size: 10px; background: #ea3943; color: white; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="text-align: center;">
        <h2 style="color: var(--p); margin-bottom: 5px;">DigiexDefai Professional Panel</h2>
        <p id="walletDisplay">Please Connect Wallet</p>
        <button onclick="connect()">Connect MetaMask</button>
    </div>

    <div class="card">
        <h3>1. New Registration</h3>
        <input type="text" id="regUser" placeholder="Unique Username (e.g. digi786)">
        <input type="text" id="regRef" placeholder="Referrer Username (e.g. digiex)">
        <button onclick="register()">Register Account</button>
    </div>

    <div class="card">
        <h3>2. Investment (USDT)</h3>
        <input type="number" id="depAmt" placeholder="Amount (Min 1 USDT)">
        <div style="display: flex; gap: 10px;">
            <button onclick="approve()" style="background: #2b2f36; color: white;">Step 1: Approve</button>
            <button onclick="deposit()">Step 2: Deposit</button>
        </div>
    </div>

    <div class="card">
        <h3>3. User Dashboard <span class="live-tag">LIVE</span></h3>
        <button onclick="fetchData()" style="background: #f0b90b; color: black; margin-bottom: 10px;">Refresh Live Data</button>
        <div class="stats-grid">
            <div class="stat-item">Username <span class="stat-val" id="st_name">--</span></div>
            <div class="stat-item">Rank <span class="stat-val" id="st_rank">--</span></div>
            <div class="stat-item">Active Deposit <span class="stat-val" id="st_active">0.00</span></div>
            <div class="stat-item">Live Profit (ROI+Cap) <span class="stat-val" id="st_daily">0.000000</span></div>
            <div class="stat-item">Network Income <span class="stat-val" id="st_net">0.00</span></div>
            <div class="stat-item">Team Size <span class="stat-val" id="st_team">0</span></div>
        </div>
    </div>

    <div class="card">
        <h3>4. Operations</h3>
        <div class="stats-grid">
            <button onclick="claimDaily()" style="background: #ea3943; color: white;">Claim Daily</button>
            <button onclick="compoundDaily()" style="background: #00c853; color: white;">Compound Daily</button>
            <button onclick="claimNetwork()" style="background: #ea3943; color: white;">Claim Network</button>
            <button onclick="compoundNetwork()" style="background: #00c853; color: white;">Compound Network</button>
        </div>
    </div>

    <div class="console" id="log">Console Ready... Click Connect Wallet.</div>
</div>

<script>
    // --- SETTINGS ---
    const CONTRACT_ADDR = "0xd93B2fe5E286757890DF2FD234641858dC30D1FF"; 
    const USDT_ADDR = "0x3b66b1e08f55af26c8ea14a73da64b6bc8d799de"; 

    const ABI = [
        "function register(string username, string referrerUsername) external",
        "function deposit(uint256 amount) external",
        "function claimDailyReward(uint256 amount) external",
        "function compoundDailyReward(uint256 amount) external",
        "function claimNetworkReward(uint256 amount) external",
        "function compoundNetworkReward(uint256 amount) external",
        "function users(address) view returns (address referrer, string username, bool registered, uint256 joinDate, uint256 totalActiveDeposit, uint256 teamActiveDeposit, uint256 teamTotalDeposit, uint256 totalDeposited, uint256 totalWithdrawn)",
        "function usersExtra(address) view returns (uint256 rewardsReferral, uint256 rewardsOnboarding, uint256 rewardsRank, uint256 reserveDailyCapital, uint256 reserveDailyROI, uint256 reserveNetwork, uint32 teamCount, uint32 directsCount, uint32 directsQuali, uint8 rank)",
        "function getRankName(uint8 r) view returns (string)",
        "function getLiveBalance(address uA) view returns (uint256 pendingROI, uint256 pendingCap)"
    ];
    const USDT_ABI = ["function approve(address s, uint256 a) returns (bool)"];

    let signer, contract, usdt;

    function log(m, err = false) {
        const l = document.getElementById("log");
        l.innerHTML += `<div style="color:${err ? '#ff5252' : '#00ff00'}">> ${m}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    async function connect() {
        if(!window.ethereum) return alert("Install MetaMask");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const a = await signer.getAddress();
        document.getElementById("walletDisplay").innerText = "Connected: " + a;
        contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
        usdt = new ethers.Contract(USDT_ADDR, USDT_ABI, signer);
        log("Wallet Connected!");
        fetchData();
        // Auto-Refresh Every 10 Seconds
        setInterval(fetchData, 10000);
    }

    async function register() {
        try {
            const u = document.getElementById("regUser").value;
            const r = document.getElementById("regRef").value;
            log(`Registering ${u}...`);
            const tx = await contract.register(u, r);
            await tx.wait();
            log("✅ Registered!");
            fetchData();
        } catch (e) { log(e.reason || e.message, true); }
    }

    async function approve() {
        try {
            const amt = ethers.utils.parseEther(document.getElementById("depAmt").value);
            log("Approving USDT...");
            const tx = await usdt.approve(CONTRACT_ADDR, amt);
            await tx.wait();
            log("✅ Approved!");
        } catch (e) { log(e.message, true); }
    }

    async function deposit() {
        try {
            const amt = ethers.utils.parseEther(document.getElementById("depAmt").value);
            log("Depositing...");
            const tx = await contract.deposit(amt);
            await tx.wait();
            log("✅ Deposit Success!");
            fetchData();
        } catch (e) { log(e.message, true); }
    }

    async function fetchData() {
        if(!contract || !signer) return;
        try {
            const a = await signer.getAddress();
            const u = await contract.users(a);
            const ex = await contract.usersExtra(a);
            const rName = await contract.getRankName(ex.rank);
            
            // --- LIVE DATA FETCH ---
            const live = await contract.getLiveBalance(a);
            
            document.getElementById("st_name").innerText = u.username || "Not Registered";
            document.getElementById("st_rank").innerText = rName;
            document.getElementById("st_active").innerText = ethers.utils.formatEther(u.totalActiveDeposit);
            document.getElementById("st_team").innerText = ex.teamCount;

            // ROI + Capital Calculation
            const totalPending = live.pendingROI.add(live.pendingCap);
            const dailyVal = ethers.utils.formatEther(totalPending);
            document.getElementById("st_daily").innerText = parseFloat(dailyVal).toFixed(6);

            // Network calculation
            const net = ethers.utils.formatEther(ex.rewardsReferral.add(ex.rewardsOnboarding).add(ex.rewardsRank).add(ex.reserveNetwork));
            document.getElementById("st_net").innerText = parseFloat(net).toFixed(4);
            
        } catch (e) { console.log(e); }
    }

    async function claimDaily() { try { const tx = await contract.claimDailyReward(0); await tx.wait(); log("Claimed!"); fetchData(); } catch(e){log(e.message, true);}}
    async function compoundDaily() { try { const tx = await contract.compoundDailyReward(0); await tx.wait(); log("Compounded!"); fetchData(); } catch(e){log(e.message, true);}}
    async function claimNetwork() { try { const tx = await contract.claimNetworkReward(0); await tx.wait(); log("Net Claimed!"); fetchData(); } catch(e){log(e.message, true);}}
    async function compoundNetwork() { try { const tx = await contract.compoundNetworkReward(0); await tx.wait(); log("Net Compounded!"); fetchData(); } catch(e){log(e.message, true);}}

</script>
</body>
</html>

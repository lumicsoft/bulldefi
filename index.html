<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Referral System DApp</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 5px; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 10px; cursor: pointer; background-color: #007BFF; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        input[type="text"], input[type="number"] { width: 95%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; }
        #log { background: #f0f0f0; padding: 10px; min-height: 100px; overflow-y: auto; border-radius: 5px; margin-top: 15px; }
    </style>
</head>
<body>

    <h1>My Referral System - BSC Testnet</h1>
    <div class="section">
        <h2>1. Wallet Connect</h2>
        <button id="connectBtn">Connect Wallet</button>
        <p>Connected Address: <span id="userAddress">N/A</span></p>
    </div>

    <div class="section">
        <h2>2. Approve Tokens</h2>
        <p>Before buying a package, you need to approve the contract to spend your tokens.</p>
        <input type="number" id="packageIdInput" placeholder="Enter Package ID (e.g., 0)">
        <button id="approveBtn">Approve Tokens for Package</button>
    </div>

    <div class="section">
        <h2>3. Buy Package</h2>
        <p>Buy a package using a referrer's address.</p>
        <input type="text" id="referrerAddressInput" placeholder="Referrer Address (or 0x0 for none)">
        <input type="number" id="buyPackageIdInput" placeholder="Enter Package ID (0-14)">
        <button id="joinBtn">Buy Package</button>
    </div>
    
    <div class="section">
        <h2>Logs</h2>
        <pre id="log"></pre>
    </div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
    // --- कॉन्ट्रैक्ट पते ---
    const REFERRAL_CONTRACT_ADDRESS = "0x36e2a2B4282e69A2129E504b732ACEdf9A16e195";
    const TOKEN_CONTRACT_ADDRESS    = "0x7b5ba20d38600eD21587d40C7910106833ee3E69";

    // --- पैकेजों की कीमतें ---
    const PACKAGE_PRICES = [
        ethers.BigNumber.from("10000000000000000"),   // 0: Beginner (0.01)
        ethers.BigNumber.from("20000000000000000"),   // 1: Bronze (0.02)
        ethers.BigNumber.from("40000000000000000"),   // 2: Advisor (0.04)
        ethers.BigNumber.from("80000000000000000"),   // 3: Silver (0.08)
        ethers.BigNumber.from("160000000000000000"),  // 4: Achiever (0.16)
        ethers.BigNumber.from("320000000000000000"),  // 5: Legend (0.32)
        ethers.BigNumber.from("640000000000000000"),  // 6: Spark (0.64)
        ethers.BigNumber.from("1280000000000000000"), // 7: Champion (1.28)
        ethers.BigNumber.from("2560000000000000000"), // 8: Gold (2.56)
        ethers.BigNumber.from("5120000000000000000"), // 9: Diamond (5.12)
        ethers.BigNumber.from("10240000000000000000"),// 10: Platinum (10.24)
        ethers.BigNumber.from("20480000000000000000"),// 11: Director (20.48)
        ethers.BigNumber.from("40960000000000000000"),// 12: Emperor (40.96)
        ethers.BigNumber.from("81920000000000000000"),// 13: Tycoon (81.92)
        ethers.BigNumber.from("163840000000000000000")// 14: Creator (163.84)
    ];

    // --- ABIs ---
    const ERC20_ABI = [
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const REFERRAL_ABI = [
        "function join(address _referrer, uint256 _packageId) external",
        "function packages(uint256) view returns (string, uint256)"
    ];

    let provider, signer, userAddress;
    let referralContract, tokenContract;

    const logEl = document.getElementById("log");
    const userAddressEl = document.getElementById("userAddress");

    function log(msg) {
        logEl.textContent += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
    }

    // --- 1. वॉलेट कनेक्ट करें ---
    document.getElementById("connectBtn").onclick = async () => {
        if (typeof window.ethereum === "undefined") {
            alert("MetaMask नहीं मिला! कृपया इसे install करें।");
            return;
        }

        try {
            // पहले BSC Testnet पर switch करने की कोशिश
            await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: "0x61" }], // BSC Testnet = 97
            });
        } catch (switchError) {
            if (switchError.code === 4902) {
                // अगर network MetaMask में नहीं है तो add करो
                try {
                    await window.ethereum.request({
                        method: "wallet_addEthereumChain",
                        params: [{
                            chainId: "0x61",
                            chainName: "BNB Smart Chain Testnet",
                            rpcUrls: ["https://data-seed-prebsc-1-s1.binance.org:8545/"],
                            nativeCurrency: {
                                name: "tBNB",
                                symbol: "tBNB",
                                decimals: 18
                            },
                            blockExplorerUrls: ["https://testnet.bscscan.com"]
                        }]
                    });
                } catch (addError) {
                    log(`❌ Error adding network: ${addError.message}`);
                    return;
                }
            } else {
                log(`❌ Network switch error: ${switchError.message}`);
                return;
            }
        }

        try {
            // अब wallet connect करो
            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            userAddress = accounts[0];
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();

            referralContract = new ethers.Contract(REFERRAL_CONTRACT_ADDRESS, REFERRAL_ABI, signer);
            tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, ERC20_ABI, signer);

            userAddressEl.textContent = userAddress;
            log(`✅ वॉलेट कनेक्ट हो गया: ${userAddress}`);
        } catch (err) {
            log(`❌ Error: ${err.message}`);
        }
    };

    // --- 2. टोकन अप्रूव करें ---
    document.getElementById("approveBtn").onclick = async () => {
        if (!signer) {
            alert("पहले वॉलेट कनेक्ट करें।");
            return;
        }

        const packageId = document.getElementById("packageIdInput").value;
        if (packageId === "" || packageId < 0 || packageId >= PACKAGE_PRICES.length) {
            alert("कृपया एक वैध पैकेज ID डालें (0-14)।");
            return;
        }

        const requiredAmount = PACKAGE_PRICES[packageId];
        log(`पैकेज ${packageId} के लिए टोकन अप्रूव कर रहे हैं। आवश्यक राशि: ${requiredAmount.toString()}`);

        try {
            const tx = await tokenContract.approve(REFERRAL_CONTRACT_ADDRESS, requiredAmount);
            log(`अप्रूव ट्रांजेक्शन भेजी गई: ${tx.hash}`);
            await tx.wait();
            log("✅ अप्रूव ट्रांजेक्शन सफल हो गई!");
        } catch (error) {
            log("❌ टोकन अप्रूव करने में एरर आया।");
            log(`❌ एरर: ${error.message}`);
        }
    };

    // --- 3. पैकेज खरीदें (Join) ---
    document.getElementById("joinBtn").onclick = async () => {
        if (!signer) {
            alert("पहले वॉलेट कनेक्ट करें।");
            return;
        }
        const referrerAddress = document.getElementById("referrerAddressInput").value || "0x0000000000000000000000000000000000000000";
        const packageId = document.getElementById("buyPackageIdInput").value;

        if (packageId === "" || packageId < 0 || packageId >= PACKAGE_PRICES.length) {
            alert("कृपया एक वैध पैकेज ID डालें (0-14)।");
            return;
        }

        log(`पैकेज ${packageId} खरीद रहे हैं...`);

        try {
            const tx = await referralContract.join(referrerAddress, packageId);
            log(`ज्वाइन ट्रांजेक्शन भेजी गई: ${tx.hash}`);
            await tx.wait();
            log("✅ पैकेज सफलतापूर्वक खरीद लिया गया!");
        } catch (error) {
            log("❌ पैकेज खरीदने में एरर आया।");
            log(`❌ एरर: ${error.message}`);
        }
    };
</script>

</body>
</html>

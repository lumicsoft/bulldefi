<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TetherDefai | Professional Testing Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #00c853;
            --secondary: #2979ff;
            --danger: #ff5252;
            --warning: #ffd600;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --border: #334155;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 900px; }

        header {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--card), var(--bg));
            border-radius: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .section { 
            background: var(--card); 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { color: var(--primary); margin-top: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h2 span { font-size: 0.9rem; background: var(--border); padding: 2px 8px; border-radius: 5px; color: var(--text); }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            background: #0f172a; 
            color: white;
            box-sizing: border-box;
        }

        button { 
            width: 100%;
            padding: 12px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer; 
            background-color: var(--secondary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            transition: all 0.3s ease;
            margin-top: 5px;
        }

        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-success { background-color: var(--primary); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); color: #000; }

        .stats-box {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .stats-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .stats-item:last-child { border: none; }

        #log { 
            background: #000; 
            color: #00ff00; 
            padding: 15px; 
            height: 150px; 
            overflow-y: auto; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            border: 1px solid var(--border);
        }

        .loader { color: var(--warning); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>TetherDefai <span style="color: var(--primary);">V2</span> Testnet</h1>
        <button id="connectBtn" class="btn-warning">Connect MetaMask Wallet</button>
        <p style="margin-top: 10px;">Connected: <span id="userAddress" style="color: var(--primary);">Not Connected</span></p>
    </header>

    <div class="grid">
        <div class="section">
            <h2><span>1</span> User Registration</h2>
            <p style="font-size: 0.8rem; color: #94a3b8;">Naye user ko system mein shamil karein.</p>
            <input type="text" id="regUser" placeholder="Choose Your Username">
            <input type="text" id="regRef" placeholder="Referrer Username (e.g. tetherdefai)">
            <button onclick="register()" class="btn-success">Register in Contract</button>
        </div>

        <div class="section">
            <h2><span>2</span> Fund & Invest</h2>
            <p style="font-size: 0.8rem; color: #94a3b8;">USDT Approve karein aur fir deposit karein.</p>
            <input type="number" id="depAmount" placeholder="Amount in USDT (e.g. 10)">
            <button onclick="approveUSDT()">Step 1: Approve USDT</button>
            <button onclick="deposit()" class="btn-success" style="margin-top: 10px;">Step 2: Deposit Funds</button>
        </div>
    </div>

    <div class="section">
        <h2><span>3</span> Personal Dashboard</h2>
        <button onclick="getUserStats()" class="btn-warning" style="width: auto; padding: 5px 20px;">Refresh Data</button>
        
        <div class="grid" style="margin-top: 15px;">
            <div class="stats-box" id="mainStats">
                <div class="stats-item"><span>Status:</span> <span id="isReg">No</span></div>
                <div class="stats-item"><span>Total Invested:</span> <span id="totalDep">0 USDT</span></div>
                <div class="stats-item"><span>Active Capital:</span> <span id="activeDep">0 USDT</span></div>
                <div class="stats-item"><span>Total Withdrawn:</span> <span id="totalWith">0 USDT</span></div>
            </div>
            <div class="stats-box" style="border-color: var(--secondary); background: rgba(41, 121, 255, 0.1);">
                <div class="stats-item"><span>Daily Rewards:</span> <span id="dailyAvail">0 USDT</span></div>
                <div class="stats-item"><span>Network Rewards:</span> <span id="netAvail">0 USDT</span></div>
                <div class="stats-item"><span>Your Rank:</span> <span id="userRank">Inviter</span></div>
                <div class="stats-item"><span>Team Size:</span> <span id="teamCount">0</span></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2><span>4</span> Reward Operations</h2>
        <div class="grid">
            <div style="text-align: center;">
                <h4>Daily ROI (ROI + Capital)</h4>
                <button onclick="claimDaily()" class="btn-danger">Withdraw Daily</button>
                <button onclick="compoundDaily()" class="btn-success">Compound Daily</button>
            </div>
            <div style="text-align: center;">
                <h4>Network Income</h4>
                <button onclick="claimNetwork()" class="btn-danger">Withdraw Network</button>
                <button onclick="compoundNetwork()" class="btn-success">Compound Network</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Terminal Console</h2>
        <div id="log">Welcome to TetherDefai Console... Pehle Wallet Connect karein.</div>
    </div>
</div>

<script>
    // --- CONTRACT CONFIG ---
    const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS"; 
    const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955"; // BSC Mainnet USDT
    
    // Sabhi important functions ka ABI
    const ABI = [
        "function register(string username, string referrerUsername) external",
        "function deposit(uint256 amount) external",
        "function claimDailyReward(uint256 amount) external",
        "function compoundDailyReward(uint256 amount) external",
        "function claimNetworkReward(uint256 amount) external",
        "function compoundNetworkReward(uint256 amount) external",
        "function users(address) view returns (address referrer, string username, bool registered, uint256 joinDate, uint256 totalActiveDeposit, uint256 teamActiveDeposit, uint256 teamTotalDeposit, uint256 totalDeposited, uint256 totalWithdrawn)",
        "function usersExtra(address) view returns (uint256 rewardsReferral, uint256 rewardsOnboarding, uint256 rewardsRank, uint256 reserveDailyCapital, uint256 reserveDailyROI, uint256 reserveNetwork, uint32 teamCount, uint32 directsCount, uint32 directsQuali, uint8 rank)",
        "function getRankName(uint8 r) view returns (string)"
    ];

    const USDT_ABI = [
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    let signer, contract, usdt;

    function log(msg) {
        const logEl = document.getElementById("log");
        logEl.innerHTML += `<br>> ${msg}`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // Connect Wallet Logic
    document.getElementById("connectBtn").onclick = async () => {
        if (!window.ethereum) return alert("MetaMask Install karein!");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const addr = await signer.getAddress();
        document.getElementById("userAddress").innerText = addr.substring(0,6)+"..."+addr.substring(38);
        
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        usdt = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
        log("Wallet Connected: " + addr);
    };

    // Registration
    async function register() {
        try {
            const user = document.getElementById("regUser").value;
            const ref = document.getElementById("regRef").value;
            log(`Registering ${user} with ref ${ref}...`);
            const tx = await contract.register(user, ref);
            await tx.wait();
            log("✅ Registration Successful!");
        } catch (e) { log("❌ Error: " + (e.data?.message || e.message)); }
    }

    // Approve & Deposit
    async function approveUSDT() {
        try {
            const val = ethers.utils.parseUnits(document.getElementById("depAmount").value, 18);
            log("Approving USDT...");
            const tx = await usdt.approve(CONTRACT_ADDRESS, val);
            await tx.wait();
            log("✅ USDT Approved!");
        } catch (e) { log("❌ Error: " + e.message); }
    }

    async function deposit() {
        try {
            const val = ethers.utils.parseUnits(document.getElementById("depAmount").value, 18);
            log("Depositing Funds...");
            const tx = await contract.deposit(val);
            await tx.wait();
            log("✅ Deposit Successful!");
            getUserStats();
        } catch (e) { log("❌ Error: " + e.message); }
    }

    // Fetch User Stats
    async function getUserStats() {
        try {
            const addr = await signer.getAddress();
            const u = await contract.users(addr);
            const ex = await contract.usersExtra(addr);
            const rName = await contract.getRankName(ex.rank);

            document.getElementById("isReg").innerText = u.registered ? "Yes" : "No";
            document.getElementById("totalDep").innerText = ethers.utils.formatEther(u.totalDeposited) + " USDT";
            document.getElementById("activeDep").innerText = ethers.utils.formatEther(u.totalActiveDeposit) + " USDT";
            document.getElementById("totalWith").innerText = ethers.utils.formatEther(u.totalWithdrawn) + " USDT";
            document.getElementById("userRank").innerText = rName;
            document.getElementById("teamCount").innerText = ex.teamCount;

            // Avail Calc
            const daily = ethers.utils.formatEther(ex.reserveDailyCapital.add(ex.reserveDailyROI));
            const net = ethers.utils.formatEther(ex.rewardsReferral.add(ex.rewardsOnboarding).add(ex.rewardsRank).add(ex.reserveNetwork));
            
            document.getElementById("dailyAvail").innerText = daily + " USDT";
            document.getElementById("netAvail").innerText = net + " USDT";

            log("Stats Updated.");
        } catch (e) { log("❌ Stats Error: " + e.message); }
    }

    // Operations
    async function claimDaily() { 
        try { const tx = await contract.claimDailyReward(0); await tx.wait(); log("✅ Daily Claimed!"); getUserStats(); } catch(e){ log("❌ Error: " + e.message); }
    }
    async function compoundDaily() { 
        try { const tx = await contract.compoundDailyReward(0); await tx.wait(); log("✅ Daily Compounded!"); getUserStats(); } catch(e){ log("❌ Error: " + e.message); }
    }
    async function claimNetwork() { 
        try { const tx = await contract.claimNetworkReward(0); await tx.wait(); log("✅ Network Claimed!"); getUserStats(); } catch(e){ log("❌ Error: " + e.message); }
    }
    async function compoundNetwork() { 
        try { const tx = await contract.compoundNetworkReward(0); await tx.wait(); log("✅ Network Compounded!"); getUserStats(); } catch(e){ log("❌ Error: " + e.message); }
    }

</script>

</body>
</html>

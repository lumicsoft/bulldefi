<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiexDefai | Ultra Pro V2 Full + History</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --p: #00ffa3; --bg: #0b0e11; --card: #161a1e; --text: #eaecef; --accent: #f0b90b; --grad: linear-gradient(135deg, #00ffa3 0%, #00bc77 100%); }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; background-image: radial-gradient(circle at 10% 20%, rgba(0, 255, 163, 0.05) 0%, transparent 40%); }
        .container { max-width: 1100px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8); position: relative; }
        .header-card { text-align: center; border-top: 4px solid var(--p); }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; color: var(--p); margin-top: 0; text-transform: uppercase; letter-spacing: 2px; }
        .main-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; border-left: 4px solid #2b2f36; }
        .stat-label { font-size: 13px; color: #848e9c; font-weight: bold; display: block; }
        .stat-value { font-size: 24px; font-weight: 700; color: #fff; }
        .stat-value span { color: var(--p); font-size: 14px; margin-left: 5px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid #2b2f36; background: #0b0e11; color: white; box-sizing: border-box; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; font-family: 'Orbitron', sans-serif; text-transform: uppercase; }
        .btn-p { background: var(--grad); color: #000; width: 100%; }
        .btn-outline { background: transparent; border: 1px solid var(--p); color: var(--p); width: 100%; }
        .btn-red { background: #ea3943; color: white; width: 100%; }
        .btn-green { background: #00c853; color: white; width: 100%; }
        .btn-yellow { background: var(--accent); color: black; }
        .hidden { display: none !important; }
        .view-mode-banner { background: #ea3943; color: white; padding: 10px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 15px; font-family: 'Orbitron'; animation: flash 2s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .rank-badge { background: var(--accent); color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-top: 10px; display: inline-block; font-size: 14px; }
        .console { background: #000; color: #00ffa3; padding: 15px; height: 100px; overflow-y: auto; border-radius: 10px; font-family: monospace; font-size: 12px; margin-top: 20px; border: 1px solid #222; }
        
        /* Table Styles */
        .table-wrap { overflow-x: auto; margin-top: 10px; border-radius: 10px; background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; color: var(--p); padding: 12px; border-bottom: 2px solid #2b2f36; font-size: 12px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #1e2329; color: #fff; }
        .type-label { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .type-deposit { background: rgba(0, 255, 163, 0.1); color: #00ffa3; }
        .type-withdraw { background: rgba(234, 57, 67, 0.1); color: #ea3943; }
        .type-compound { background: rgba(240, 185, 11, 0.1); color: #f0b90b; }
        
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card header-card">
        <h1 id="st_name_top">DigiexDefai Pro</h1>
        
        <div style="max-width: 600px; margin: 15px auto; display: flex; gap: 5px;">
            <input type="text" id="viewInput" placeholder="Enter Username or Address" style="margin:0;">
            <button class="btn-yellow" onclick="handleSearch()" style="padding: 0 20px; white-space: nowrap;">VIEW MODE</button>
        </div>

        <p id="walletDisplay" style="color: #848e9c;">Web3 Secure Connection Ready</p>
        <button class="btn-p" onclick="connect()" id="connBtn" style="max-width: 300px;">Connect Wallet</button>
        <div id="rankDisplay" class="rank-badge hidden">Rank: Investor</div>
        <button id="exitView" class="btn-outline hidden" onclick="location.reload()" style="max-width:200px; margin: 10px auto; border-color:white; color:white;">Exit View Mode</button>
    </div>

    <div id="viewModeAlert" class="view-mode-banner hidden">⚠️ READ-ONLY ACCESS ENABLED (ACTIONS DISABLED)</div>

    <div id="regSection" class="card hidden">
        <h2 style="text-align: center;">Account Registration</h2>
        <div style="max-width: 500px; margin: auto;">
            <label>Username</label><input type="text" id="regUser" placeholder="Min 3 chars">
            <label>Referrer</label><input type="text" id="regRef" placeholder="Referrer Username">
            <button class="btn-p" onclick="register()">Launch Account</button>
        </div>
    </div>

    <div id="mainDashboard" class="hidden">
        <div class="card">
            <div id="referralBox" style="margin-bottom: 25px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px;">
                <p style="font-size: 13px; color: var(--p); font-weight: bold;">YOUR REFERRAL LINK</p>
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <input type="text" id="refLink" readonly style="max-width: 400px; margin: 0; text-align: center; height: 45px; border-color: var(--p);">
                    <button id="copyBtn" class="btn-yellow" style="padding: 0 25px; height: 45px;" onclick="copyRef()">COPY</button>
                </div>
            </div>

            <div class="main-stats">
                <div class="stat-box"><span class="stat-label">TOTAL DEPOSITED</span><span class="stat-value" id="st_total_dep">0.00 <span>USDT</span></span></div>
                <div class="stat-box" style="border-left-color: var(--p);"><span class="stat-label">ACTIVE CAPITAL</span><span class="stat-value" id="st_active">0.00 <span>USDT</span></span></div>
                <div class="stat-box"><span class="stat-label">TOTAL EARNINGS</span><span class="stat-value" id="st_total_earned">0.00 <span>USDT</span></span></div>
                <div class="stat-box"><span class="stat-label">LIVE WITHDRAWABLE ROI</span><span class="stat-value" id="st_withdrawable_roi" style="color: var(--p);">0.0000 <span>USDT</span></span></div>
                <div class="stat-box"><span class="stat-label">NETWORK INCOME</span><span class="stat-value" id="st_net_income">0.00 <span>USDT</span></span></div>
                <div class="stat-box"><span class="stat-label">TEAM MEMBERS</span><span class="stat-value" id="st_team_count">0 <span>Users</span></span></div>
            </div>
            <button class="btn-outline" onclick="fetchData(); fetchHistory();" style="margin-top: 15px;">REFRESH DATA</button>
        </div>

        <div id="actionGrid" class="grid-2">
            <div class="card">
                <h3>Investment Port</h3>
                <input type="number" id="depAmt" placeholder="Amount USDT">
                <div class="grid-2">
                    <button class="btn-outline" onclick="approve()">1. Approve</button>
                    <button class="btn-p" onclick="deposit()">2. Deposit</button>
                </div>
            </div>
            <div class="card">
                <h3>Financial Hub</h3>
                <div class="grid-2" style="margin-bottom: 10px;">
                    <button class="btn-red" onclick="claimDaily()">Claim ROI</button>
                    <button class="btn-green" onclick="compoundDaily()">Comp ROI</button>
                </div>
                <div class="grid-2">
                    <button class="btn-red" onclick="claimNetwork()">Claim Net</button>
                    <button class="btn-green" onclick="compoundNetwork()">Comp Net</button>
                </div>
                <button class="btn-outline" onclick="withdrawPrincipal()" style="width: 100%; margin-top: 15px; border-color: #ea3943; color: #ea3943;">EMERGENCY PRINCIPAL EXIT (-20%)</button>
            </div>
        </div>

        <div class="card">
            <h3>Transaction History</h3>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Transaction Hash</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="3" style="text-align:center; color:#848e9c;">Connecting to blockchain...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>Network Explorer</h3>
            <div class="grid-2" style="grid-template-columns: 2fr 1fr; align-items: center;">
                <select id="levelSel" style="margin: 0;">
                    <script>for(let i=1; i<=25; i++) document.write(`<option value="${i}">Level ${i}</option>`);</script>
                </select>
                <button class="btn-p" onclick="loadTeam()">Expand View</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>MEMBER</th><th>ACTIVE DEP</th><th>STATUS</th><th>BUSINESS</th></tr></thead>
                    <tbody id="teamBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="console" id="log">SYSTEM STATUS: ENCRYPTED...</div>
</div>

<script>
    const CONTRACT_ADDR = "0x33Ad74E9FB3aeA563baD0Bbe36D3E911c231200A";
    const USDT_ADDR = "0x3b66b1e08f55af26c8ea14a73da64b6bc8d799de";
    const RPC_URL = "https://polygon-rpc.com"; 

    const ABI = [
        "event NewDeposit(address indexed user, uint256 amount)",
        "event WithdrawnROI(address indexed user, uint256 amount)",
        "event CompoundedROI(address indexed user, uint256 amount)",
        "event PrincipalWithdrawn(address indexed user, uint256 amount)",
        "function usernameToAddress(string) view returns (address)",
        "function register(string u, string r) external",
        "function users(address) view returns (address referrer, string username, bool registered, uint256 joinDate, uint256 totalActiveDeposit, uint256 teamActiveDeposit, uint256 teamTotalDeposit, uint256 totalDeposited, uint256 totalWithdrawn, uint256 totalEarnings)",
        "function usersExtra(address) view returns (uint256 rewardsReferral, uint256 rewardsOnboarding, uint256 rewardsRank, uint256 reserveDailyCapital, uint256 reserveDailyROI, uint256 reserveNetwork, uint32 teamCount, uint32 directsCount, uint32 directsQuali, uint8 rank)",
        "function getLiveBalance(address uA) view returns (uint256 pendingROI, uint256 pendingCap)",
        "function deposit(uint256 a) external",
        "function claimDailyReward(uint256 a) external",
        "function compoundDailyReward(uint256 a) external",
        "function claimNetworkReward(uint256 a) external",
        "function compoundNetworkReward(uint256 a) external",
        "function withdrawPrincipal() external",
        "function getRankName(uint8 r) view returns (string)",
        "function getLevelTeamDetails(address _upline, uint256 _level) view returns (string[] names, address[] wallets, uint256[] joinDates, uint256[] activeDeps, uint256[] teamTotalDeps, uint256[] teamActiveDeps, uint256[] withdrawals)"
    ];

    const USDT_ABI = ["function approve(address s, uint256 a) returns (bool)"];

    let provider, contract, usdt, userAddress, isViewMode = false;

    provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    contract = new ethers.Contract(CONTRACT_ADDR, ABI, provider);

    function log(m, err = false) {
        const l = document.getElementById("log");
        l.innerHTML += `<div style="color:${err ? '#ff5252' : '#00ffa3'}">> ${m}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    async function handleSearch() {
        const input = document.getElementById("viewInput").value.trim();
        if(!input) return alert("Enter username or address");
        try {
            let target;
            if (ethers.utils.isAddress(input)) { target = input; } 
            else { 
                target = await contract.usernameToAddress(input);
                if (target === "0x0000000000000000000000000000000000000000") throw new Error("User not found");
            }
            isViewMode = true;
            userAddress = target;
            
            document.getElementById("viewModeAlert").classList.remove("hidden");
            document.getElementById("actionGrid").classList.add("hidden");
            document.getElementById("connBtn").classList.add("hidden");
            document.getElementById("exitView").classList.remove("hidden");
            document.getElementById("copyBtn").classList.add("hidden");
            document.getElementById("mainDashboard").classList.remove("hidden");
            
            fetchData();
            fetchHistory();
            log("View Mode Active: " + input);
        } catch (e) { alert(e.message); }
    }

    async function connect() {
        if(!window.ethereum) return alert("Install MetaMask");
        const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        await web3Provider.send("eth_requestAccounts", []);
        const signer = web3Provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
        usdt = new ethers.Contract(USDT_ADDR, USDT_ABI, signer);
        isViewMode = false;
        
        document.getElementById("connBtn").classList.add("hidden");
        document.getElementById("walletDisplay").innerText = "CONNECTED: " + userAddress.substring(0,6)+"...";
        checkStatus();
    }

    async function checkStatus() {
        const u = await contract.users(userAddress);
        if(u.registered) {
            document.getElementById("regSection").classList.add("hidden");
            document.getElementById("mainDashboard").classList.remove("hidden");
            fetchData();
            fetchHistory();
            setInterval(fetchData, 15000);
        } else {
            document.getElementById("regSection").classList.remove("hidden");
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('ref')) document.getElementById("regRef").value = urlParams.get('ref');
        }
    }

    async function fetchData() {
        try {
            const u = await contract.users(userAddress);
            const ex = await contract.usersExtra(userAddress);
            const live = await contract.getLiveBalance(userAddress);
            const rName = await contract.getRankName(ex.rank);

            document.getElementById("st_name_top").innerText = "HELLO, " + u.username + (isViewMode ? " (VIEW)" : "");
            document.getElementById("st_total_dep").innerText = ethers.utils.formatEther(u.totalDeposited);
            document.getElementById("st_active").innerText = ethers.utils.formatEther(u.totalActiveDeposit);
            
            const liveWithdrawable = live.pendingROI.add(live.pendingCap);
            const netIncome = ex.rewardsReferral.add(ex.rewardsOnboarding).add(ex.rewardsRank).add(ex.reserveNetwork);
            const totalEarned = u.totalWithdrawn.add(liveWithdrawable).add(netIncome);

            document.getElementById("st_total_earned").innerText = parseFloat(ethers.utils.formatEther(totalEarned)).toFixed(4);
            document.getElementById("st_withdrawable_roi").innerText = parseFloat(ethers.utils.formatEther(liveWithdrawable)).toFixed(6);
            document.getElementById("st_net_income").innerText = ethers.utils.formatEther(netIncome);
            document.getElementById("st_team_count").innerText = ex.teamCount;
            document.getElementById("rankDisplay").innerText = "Rank: " + rName;
            document.getElementById("rankDisplay").classList.remove("hidden");
            
            if(!isViewMode) document.getElementById("refLink").value = window.location.origin + window.location.pathname + "?ref=" + u.username;
        } catch (e) { console.error(e); }
    }

    async function fetchHistory() {
        const body = document.getElementById("historyBody");
        try {
            const depFilter = contract.filters.NewDeposit(userAddress);
            const withFilter = contract.filters.WithdrawnROI(userAddress);
            const compFilter = contract.filters.CompoundedROI(userAddress);
            const princFilter = contract.filters.PrincipalWithdrawn(userAddress);

            const [deps, withs, comps, princs] = await Promise.all([
                contract.queryFilter(depFilter, -5000),
                contract.queryFilter(withFilter, -5000),
                contract.queryFilter(compFilter, -5000),
                contract.queryFilter(princFilter, -5000)
            ]);

            let events = [
                ...deps.map(e => ({ type: 'DEPOSIT', amount: e.args.amount, hash: e.transactionHash, cls: 'type-deposit' })),
                ...withs.map(e => ({ type: 'WITHDRAWAL', amount: e.args.amount, hash: e.transactionHash, cls: 'type-withdraw' })),
                ...comps.map(e => ({ type: 'COMPOUND', amount: e.args.amount, hash: e.transactionHash, cls: 'type-compound' })),
                ...princs.map(e => ({ type: 'PRINCIPAL EXIT', amount: e.args.amount, hash: e.transactionHash, cls: 'type-withdraw' }))
            ];

            if(events.length === 0) {
                body.innerHTML = "<tr><td colspan='3' style='text-align:center;'>No recent activity</td></tr>";
                return;
            }

            body.innerHTML = events.sort((a,b) => 0.5 - Math.random()).slice(0,10).map(ev => `
                <tr>
                    <td><span class="type-label ${ev.cls}">${ev.type}</span></td>
                    <td>${ethers.utils.formatEther(ev.amount)} USDT</td>
                    <td><a href="https://polygonscan.com/tx/${ev.hash}" target="_blank" style="color:var(--p); font-size:11px;">${ev.hash.substring(0,15)}...</a></td>
                </tr>
            `).join('');
        } catch(e) { body.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Unable to load history</td></tr>"; }
    }

    async function loadTeam() {
        const lvl = document.getElementById("levelSel").value;
        const body = document.getElementById("teamBody");
        body.innerHTML = "<tr><td colspan='4'>Syncing...</td></tr>";
        try {
            const data = await contract.getLevelTeamDetails(userAddress, lvl);
            body.innerHTML = "";
            if(data.names.length == 0) return body.innerHTML = "<tr><td colspan='4' align='center'>Empty Level</td></tr>";
            for(let i=0; i<data.names.length; i++) {
                body.innerHTML += `<tr><td>${data.names[i]}</td><td>${ethers.utils.formatEther(data.activeDeps[i])}</td><td>${data.activeDeps[i]>0?'✅ Active':'❌ Inactive'}</td><td>${ethers.utils.formatEther(data.teamTotalDeps[i])}</td></tr>`;
            }
        } catch(e) { log("Sync error", true); }
    }

    async function register() {
        if(isViewMode) return;
        try {
            const user = document.getElementById("regUser").value;
            const ref = document.getElementById("regRef").value || "admin";
            log("Registering...");
            const tx = await contract.register(user, ref);
            await tx.wait();
            location.reload();
        } catch(e) { log(e.message, true); }
    }

    async function approve() {
        if(isViewMode) return;
        try {
            const amt = ethers.utils.parseEther(document.getElementById("depAmt").value);
            log("Approving USDT...");
            const tx = await usdt.approve(CONTRACT_ADDR, amt);
            await tx.wait();
            log("✅ Approved!");
        } catch(e) { log(e.message, true); }
    }

    async function deposit() {
        if(isViewMode) return;
        try {
            const amt = ethers.utils.parseEther(document.getElementById("depAmt").value);
            log("Depositing...");
            const tx = await contract.deposit(amt);
            await tx.wait();
            log("✅ Success!");
            fetchData();
            fetchHistory();
        } catch(e) { log(e.message, true); }
    }

    async function withdrawPrincipal() {
        if(isViewMode) return;
        if(confirm("Exit with 20% fee?")) {
            try {
                const tx = await contract.withdrawPrincipal();
                await tx.wait();
                log("✅ Exit Success");
                fetchData();
                fetchHistory();
            } catch(e) { log(e.message, true); }
        }
    }

    async function claimDaily() { if(isViewMode) return; const tx = await contract.claimDailyReward(0); await tx.wait(); fetchData(); fetchHistory(); }
    async function compoundDaily() { if(isViewMode) return; const tx = await contract.compoundDailyReward(0); await tx.wait(); fetchData(); fetchHistory(); }
    async function claimNetwork() { if(isViewMode) return; const tx = await contract.claimNetworkReward(0); await tx.wait(); fetchData(); fetchHistory(); }
    async function compoundNetwork() { if(isViewMode) return; const tx = await contract.compoundNetworkReward(0); await tx.wait(); fetchData(); fetchHistory(); }
    function copyRef() { const c = document.getElementById("refLink"); c.select(); document.execCommand("copy"); log("Referral Copied!"); }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiexDefai | Ultra Pro Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root { --p: #00ffa3; --bg: #060809; --card: #121619; --text: #eaecef; --accent: #f0b90b; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Glass Cards */
        .card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #2b2f36; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .header-card { text-align: center; border-bottom: 3px solid var(--p); }
        
        h2, h3 { color: var(--p); margin-top: 0; }
        
        /* Stats Grid */
        .main-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .stat-box { background: #1e2329; padding: 15px; border-radius: 12px; border: 1px solid #333; transition: 0.3s; }
        .stat-box:hover { border-color: var(--p); transform: translateY(-3px); }
        .stat-label { font-size: 12px; color: #848e9c; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: bold; color: white; }
        .stat-value span { color: var(--p); font-size: 14px; margin-left: 4px; }

        /* Referral Section */
        .ref-select { width: 100%; padding: 12px; background: #1e2329; color: white; border-radius: 8px; border: 1px solid #444; margin-bottom: 10px; }
        .team-table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #0b0e11; color: var(--p); }
        td { padding: 12px; border-bottom: 1px solid #2b2f36; }

        /* Controls */
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #0b0e11; color: white; box-sizing: border-box; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-p { background: var(--p); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--p); color: var(--p); }
        .btn-yellow { background: var(--accent); color: black; }
        .btn-red { background: #ea3943; color: white; }
        .btn-green { background: #00c853; color: white; }
        button:hover { filter: brightness(1.2); }

        .console { background: #000; color: #00ff00; padding: 15px; height: 120px; overflow-y: auto; border-radius: 8px; font-family: monospace; font-size: 12px; margin-top: 10px; border: 1px solid #333; }
        .live-pulse { height: 8px; width: 8px; background: #ea3943; border-radius: 50%; display: inline-block; margin-right: 5px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card header-card">
        <h2 id="st_name">Welcome to DigiexDefai</h2>
        <p id="walletDisplay" style="font-size: 13px; color: #848e9c;">Wallet Not Connected</p>
        <button class="btn-p" onclick="connect()" id="connBtn">Connect MetaMask</button>
    </div>

    <div class="card">
        <h3>User Statistics <span style="font-size: 12px; color: #848e9c;"><span class="live-pulse"></span>LIVE DATA</span></h3>
        <div class="main-stats">
            <div class="stat-box">
                <span class="stat-label">Total Deposits</span>
                <span class="stat-value" id="st_total_dep">0.00 <span>USDT</span></span>
            </div>
            <div class="stat-box" style="border-left: 3px solid var(--p);">
                <span class="stat-label">Active Deposit</span>
                <span class="stat-value" id="st_active">0.00 <span>USDT</span></span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Total Earned</span>
                <span class="stat-value" id="st_total_earned">0.00 <span>USDT</span></span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Total Withdrawn</span>
                <span class="stat-value" id="st_total_withdrawn">0.00 <span>USDT</span></span>
            </div>
            <div class="stat-box" style="background: #162a22;">
                <span class="stat-label">Withdrawable ROI</span>
                <span class="stat-value" id="st_withdrawable_roi" style="color: var(--p);">0.0000 <span>USDT</span></span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Network Income</span>
                <span class="stat-value" id="st_net_income">0.00 <span>USDT</span></span>
            </div>
        </div>
        <button class="btn-yellow" onclick="fetchData()" style="margin-top: 15px; width: 100%;">Refresh Data</button>
    </div>

    <div class="main-stats">
        <div class="card">
            <h3>Investment</h3>
            <input type="number" id="depAmt" placeholder="Amount USDT">
            <div class="btn-group">
                <button class="btn-outline" onclick="approve()">1. Approve</button>
                <button class="btn-p" onclick="deposit()">2. Deposit</button>
            </div>
            <p style="font-size: 11px; color: #848e9c; margin-top: 10px;">Min: 1 USDT | Max Positions: 100</p>
        </div>
        <div class="card">
            <h3>Operations</h3>
            <div class="btn-group" style="grid-template-columns: 1fr 1fr;">
                <button class="btn-red" onclick="claimDaily()">Claim Daily</button>
                <button class="btn-green" onclick="compoundDaily()">Compound Daily</button>
                <button class="btn-red" onclick="claimNetwork()">Claim Net</button>
                <button class="btn-green" onclick="compoundNetwork()">Comp Net</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Team Details (Level 1-20)</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="levelSel" class="ref-select">
                <script>
                    for(let i=1; i<=20; i++) document.write(`<option value="${i}">Level ${i}</option>`);
                </script>
            </select>
            <button class="btn-p" onclick="loadTeam()" style="width: 150px; padding: 10px;">Show Team</button>
        </div>
        <div class="team-table-container">
            <table id="teamTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Active Dep.</th>
                        <th>Team Size</th>
                        <th>Total Dep.</th>
                    </tr>
                </thead>
                <tbody id="teamBody">
                    <tr><td colspan="4" style="text-align:center;">Select level and click show</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="console" id="log">Dashboard Ready...</div>
</div>

<script>
    const CONTRACT_ADDR = "0xd93B2fe5E286757890DF2FD234641858dC30D1FF";
    const USDT_ADDR = "0x3b66b1e08f55af26c8ea14a73da64b6bc8d799de";

    const ABI = [
        "function register(string u, string r) external",
        "function deposit(uint256 a) external",
        "function claimDailyReward(uint256 a) external",
        "function compoundDailyReward(uint256 a) external",
        "function claimNetworkReward(uint256 a) external",
        "function compoundNetworkReward(uint256 a) external",
        "function users(address) view returns (address referrer, string username, bool registered, uint256 joinDate, uint256 totalActiveDeposit, uint256 teamActiveDeposit, uint256 teamTotalDeposit, uint256 totalDeposited, uint256 totalWithdrawn)",
        "function usersExtra(address) view returns (uint256 rewardsReferral, uint256 rewardsOnboarding, uint256 rewardsRank, uint256 reserveDailyCapital, uint256 reserveDailyROI, uint256 reserveNetwork, uint32 teamCount, uint32 directsCount, uint32 directsQuali, uint8 rank)",
        "function getLiveBalance(address uA) view returns (uint256 pendingROI, uint256 pendingCap)",
        "function getLevelTeamDetails(address _upline, uint256 _level) view returns (string[] names, address[] wallets, uint256[] joinDates, uint256[] activeDeps, uint256[] teamTotalDeps, uint256[] teamActiveDeps, uint256[] withdrawals)"
    ];
    const USDT_ABI = ["function approve(address s, uint256 a) returns (bool)"];

    let signer, contract, usdt;

    function log(m, err = false) {
        const l = document.getElementById("log");
        l.innerHTML += `<div style="color:${err ? '#ff5252' : '#00ff00'}">> ${m}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    async function connect() {
        if(!window.ethereum) return alert("Install MetaMask");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const a = await signer.getAddress();
        document.getElementById("walletDisplay").innerText = "Address: " + a.substring(0,6)+"..."+a.substring(38);
        contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
        usdt = new ethers.Contract(USDT_ADDR, USDT_ABI, signer);
        document.getElementById("connBtn").style.display = "none";
        log("Connected Successfully");
        fetchData();
        setInterval(fetchData, 15000);
    }

    async function fetchData() {
        if(!contract) return;
        try {
            const a = await signer.getAddress();
            const u = await contract.users(a);
            const ex = await contract.usersExtra(a);
            const live = await contract.getLiveBalance(a);

            // Calculation Logic
            const totalWithdrawable = live.pendingROI.add(live.pendingCap);
            const netReward = ex.rewardsReferral.add(ex.rewardsOnboarding).add(ex.rewardsRank).add(ex.reserveNetwork);
            
            // UI Update
            document.getElementById("st_name").innerText = "Welcome, " + (u.username || "Guest");
            document.getElementById("st_active").innerText = ethers.utils.formatEther(u.totalActiveDeposit);
            document.getElementById("st_total_dep").innerText = ethers.utils.formatEther(u.totalDeposited);
            document.getElementById("st_total_withdrawn").innerText = ethers.utils.formatEther(u.totalWithdrawn);
            document.getElementById("st_withdrawable_roi").innerText = parseFloat(ethers.utils.formatEther(totalWithdrawable)).toFixed(6);
            document.getElementById("st_net_income").innerText = ethers.utils.formatEther(netReward);
            
            // Total Earned = Withdrawn + Pending ROI + Pending Net
            const totalEarned = u.totalWithdrawn.add(totalWithdrawable).add(netReward);
            document.getElementById("st_total_earned").innerText = parseFloat(ethers.utils.formatEther(totalEarned)).toFixed(4);

        } catch (e) { console.error(e); }
    }

    async function loadTeam() {
        if(!contract) return;
        const level = document.getElementById("levelSel").value;
        const a = await signer.getAddress();
        const teamBody = document.getElementById("teamBody");
        teamBody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
        
        try {
            const data = await contract.getLevelTeamDetails(a, level);
            teamBody.innerHTML = "";
            if(data.names.length == 0) {
                teamBody.innerHTML = "<tr><td colspan='4'>No members found in this level</td></tr>";
                return;
            }
            for(let i=0; i<data.names.length; i++) {
                teamBody.innerHTML += `
                    <tr>
                        <td>${data.names[i]}</td>
                        <td>${ethers.utils.formatEther(data.activeDeps[i])}</td>
                        <td>${data.teamActiveDeps[i] > 0 ? 'Active' : 'Inactive'}</td>
                        <td>${ethers.utils.formatEther(data.teamTotalDeps[i])}</td>
                    </tr>
                `;
            }
        } catch(e) { log("Team Fetch Error", true); }
    }

    // Reuse operations from previous code
    async function approve() { try { const amt = ethers.utils.parseEther(document.getElementById("depAmt").value); log("Approving..."); const tx = await usdt.approve(CONTRACT_ADDR, amt); await tx.wait(); log("✅ Approved!"); } catch (e) { log(e.message, true); } }
    async function deposit() { try { const amt = ethers.utils.parseEther(document.getElementById("depAmt").value); log("Depositing..."); const tx = await contract.deposit(amt); await tx.wait(); log("✅ Success!"); fetchData(); } catch (e) { log(e.message, true); } }
    async function claimDaily() { const tx = await contract.claimDailyReward(0); await tx.wait(); fetchData(); }
    async function compoundDaily() { const tx = await contract.compoundDailyReward(0); await tx.wait(); fetchData(); }
    async function claimNetwork() { const tx = await contract.claimNetworkReward(0); await tx.wait(); fetchData(); }
    async function compoundNetwork() { const tx = await contract.compoundNetworkReward(0); await tx.wait(); fetchData(); }
</script>

</body>
</html>
